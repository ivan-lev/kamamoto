# Redirect HTTP -> HTTPS
http://kamamoto.ru, http://158.255.5.107 {
    redir https://kamamoto.ru{uri} 302
}

kamamoto.ru {
    # ID pages: remove trailing slash, i.e. '/bowls/1773' and 'exhibitions/8'
	@idToRemoveSlash {
        path_regexp id ^(.*/\d+)/$
    }
    redir @idToRemoveSlash {re.id.1} 301

    # ===== Static pages: remove trailing slash =====
    @staticToRemoveSlash {
        path_regexp static ^/(about|assistants|contacts|dictionary|documents|downloads|thanksletters|japanese-exhibitions|japanese-societies|ceramic-styles/[^/]+)/$
    }
    redir @staticToRemoveSlash /{re.static.1} 301

    # ===== Listing pages: force trailing slash =====
    @listingToAddSlash {
        path_regexp list ^(/collection(?:/[^/0-9][^/]*)?|/exhibitions|/useful|/ceramic-styles)$
    }
    redir @listingToAddSlash {re.list.1}/ 301

    # Global headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
    }

    @assets {
        not path /api/*
        path *.js *.css *.svg *.png *.jpg *.woff *.woff2 *.webp
    }
    header @assets {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # Set up compression for non-html text asets
    @compressed {
        path *.js *.css *.svg
    }
    encode @compressed gzip

    # Handle API requests
    handle /api/* {
        reverse_proxy http://back:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }

        header {
            Cache-Control "no-cache, must-revalidate"
        }
    }

    # Static files from backend
    handle /static/* {
        reverse_proxy http://back:3000
    }

    # ===== Yuding SPA =====
    # Redirect from  /yuding to /yuding/
    redir /yuding /yuding/ 301

    handle_path /yuding/* {
        root * /srv/yuding

        # Correct 3-step SPA fallback
        try_files {path} {path}/ /index.html

        file_server
    }

    # Serve static files
    root * /srv/front

    # ===== Main SPA =====
    handle {
        root * /srv/front

        try_files {path} {path}/ /index.html

        header {
            # X-My-Header "here"
            # Cache-Control "no-cache, must-revalidate"
            # Content-Security-Policy "
            #     default-src 'self';
            #     script-src 'self' 'unsafe-inline';
            #     style-src 'self' 'unsafe-inline';
            #     img-src 'self' https: data: blob:;
            #     font-src 'self';
            #     connect-src 'self' https:;
            #     frame-src https: blob:;
            #     frame-ancestors 'self' https:;
            # "
            # Cross-Origin-Opener-Policy "same-origin"
            # Cross-Origin-Resource-Policy "same-site"
            Permissions-Policy "geolocation=(), microphone=(), camera=()"
            Referrer-Policy "strict-origin-when-cross-origin"
            X-Content-Type-Options "nosniff"
            X-Frame-Options "SAMEORIGIN"
            # -ETag
            match header Content-Type text/html*
        }

        file_server
    }
}