http://kamamoto.ru, http://158.255.5.107 {
    redir https://kamamoto.ru{uri} permanent
}

kamamoto.ru {

    encode gzip

    # Handle API requests
    handle /api/* {
        reverse_proxy http://back:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }

        # Do not cache
        header Cache-Control "no-cache, no-store, must-revalidate"
    }

    # Static files from backend
    handle /static/* {
        reverse_proxy http://back:3000

		@images {
            path *.jpg *.jpeg *.png *.gif *.webp *.ico *.svg
        }

        # 1 year cache for images
        header @images Cache-Control "public, immutable, max-age=31536000"
        # 1 hour cache for non-images
        header !@images Cache-Control "public, max-age=3600"
    }
    
    # Serve static files
    root * /srv/front
    
    # SPA fallback
    @notStatic {
        not file
        path /*
    }
    handle @notStatic {
        rewrite * /index.html
        file_server

        # Don't cache for SPA routes
        header Cache-Control "no-cache, no-store, must-revalidate"
    }

	# Check if build already has precompressed virsions of files
    file_server {
        precompressed gzip
    }

    # Security headers
    header {
        Vary "Accept-Encoding"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
    }
}