# Redirect HTTP -> HTTPS
http://kamamoto.ru, http://158.255.5.107 {
    redir https://kamamoto.ru{uri} permanent
}

kamamoto.ru {

    # Set up compression
    encode gzip

    # Handle API requests
    handle /api/* {
        reverse_proxy http://back:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }

        # Do not cache
        header Cache-Control "no-cache, must-revalidate"
    }

    # Static files from backend
    handle /static/* {
        reverse_proxy http://back:3000

		@images {
            path *.jpg *.jpeg *.png *.gif *.webp *.ico *.svg
        }

        # 1 year cache for images
        header @images Cache-Control "public, immutable, max-age=31536000"
        # 1 hour cache for non-images
        header !@images Cache-Control "public, max-age=3600"
    }

    # ===== Yuding SPA =====

    # Redirect from  /yuding to /yuding/
    redir /yuding /yuding/ 301

    handle_path /yuding/* {
        root * /srv/yuding

        # Longtime cache for static
        @yudingStatic {
            path *.css *.js *.png *.jpg *.jpeg *.svg *.webp *.woff2
        }
        header @yudingStatic Cache-Control "public, immutable, max-age=31536000"

        # Correct 3-step SPA fallback
        try_files {path} {path}/ /index.html

        file_server {
            precompressed gzip
        }
    }

    # Serve static files
    root * /srv/front

    # Frontend static files cache
    @frontendStatic {
        path *.css *.js *.woff2 *.svg *.png *.jpg *.jpeg *.webp
    }
    header @frontendStatic Cache-Control "public, immutable, max-age=31536000"

    # Do not cache HTML
    @html {
        path *.html
    }
    header @html Cache-Control "no-cache, must-revalidate"

    # SPA fallback for any non-file
    @notStatic {
        not file
        not path /yuding/*
        path /*
    }
    handle @notStatic {
        rewrite * /index.html
        file_server

        # Don't cache for SPA routes
        header Cache-Control "no-cache, must-revalidate"
    }

	# Check if build already has precompressed virsions of files
    file_server {
        precompressed gzip
    }

    # Security headers
    header {
        Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval';
            style-src 'self' 'unsafe-inline';
            img-src 'self' data:;
            font-src 'self';
            connect-src 'self';
            frame-ancestors 'none';
        "
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Resource-Policy "same-origin"
        Cross-Origin-Embedder-Policy "unsafe-none"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Vary "Accept-Encoding"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
    }
}