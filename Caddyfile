# Redirect HTTP -> HTTPS
http://kamamoto.ru, http://158.255.5.107 {
    redir https://kamamoto.ru{uri} 302
}

kamamoto.ru {
    # Set up compression for non-html text asets
    @compressed {
        path *.js *.css
    }
    encode @compressed gzip

    # Handle API requests
    handle /api/* {
        reverse_proxy http://back:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote}
        }

        # Do not cache
        header {
            # Totally turn off cache and 304
            Cache-Control "no-store, no-cache, must-revalidate"
            Pragma "no-cache"
            Expires "0"

            -ETag

            # Remove security-headers to not mixing them with backend headers
            -Content-Security-Policy
            -Cross-Origin-Opener-Policy
            -Cross-Origin-Resource-Policy
            -Cross-Origin-Embedder-Policy
            -X-Frame-Options
            -X-Content-Type-Options
            -Referrer-Policy
            -Permissions-Policy
            -X-XSS-Protection
            -Strict-Transport-Security
        }
    }

    # Static files from backend
    handle /static/* {
        reverse_proxy http://back:3000

		@images {
            path *.jpg *.jpeg *.png *.gif *.webp *.ico *.svg
        }

        # 1 year cache for images
        header @images Cache-Control "public, max-age=31536000"
    }

    # ===== Yuding SPA =====

    # Redirect from  /yuding to /yuding/
    redir /yuding /yuding/ 301

    handle_path /yuding/* {
        root * /srv/yuding

        # Correct 3-step SPA fallback
        try_files {path} {path}/ /index.html
    }

    # Serve static files
    root * /srv/front

    # Do not cache HTML and fix ios mobile problems
    @html {
        path *.html
    }
    header @html {
        Cache-Control "no-store"
        -ETag
    }

    # SPA fallback for any non-file
    @notStatic {
        not file
        not path /yuding/*
        path /*
    }
    handle @notStatic {
        rewrite * /index.html
        file_server

        # Don't cache for SPA routes
        header {
            Cache-Control "no-cache, must-revalidate"
            -ETag
        }
    }

    file_server

    # Security headers
    header {
        Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline';
            style-src 'self' 'unsafe-inline';
            img-src 'self' https: data:;
            font-src 'self';
            connect-src 'self' https:;
            frame-src https:;          
            frame-ancestors 'self';
        "
        Cross-Origin-Opener-Policy "same-origin"
        Cross-Origin-Resource-Policy "same-origin"
        Cross-Origin-Embedder-Policy "unsafe-none"
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        Referrer-Policy "strict-origin-when-cross-origin"
        Strict-Transport-Security "max-age=86400"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
    }
}